# remux-script

A script that remuxes .mkv files to .mp4 files using ffmpeg.

This script was heavily inspired by the [prorec](https://github.com/gmzorz/prerecs) script written by [Gmzorz](https://github.com/gmzorz).

## Requirements

-   [FFmpeg](https://ffmpeg.org/download.html)
    -   Get the Windows executable from one ofthe two mirrors. The executable can either by placed in the `C:\Windows\System32` or added as an evironment variable (Path section).
        -   New environment variables may require a restart before they work.
-   [Quicktime](https://support.apple.com/kb/dl837?locale=en_US) [OPTIONAL]
    -   In order to encode using the ProRes codec (if the user chooses to do so), download and install Quicktime.

## Usage

Firstly, ensure that ffmpeg is installed; on windows, open the terminal (powershell or cmd) and use the command `ffmpeg`. The output should give version and copyright information followed by various flags. Secondly, download the source code, and move the `remux.bat` file to a directory that contains the files you want to remux (optionally, you can keep the batch file in it's own directory and drag files into the directory or over top the batchfile). On the first launch the `remux.bat` file will create a config file named `conf.ini` (Please see the next section to understand the config file). After running the script successully, you should be greeted with a `Operation(s) completed successfully message`.



## Config file

From the first release (0.1.0) onwrads, the script will utilize a `conf.ini` file. This will not be included inthe github repository or release packages, but instead will be auto-generated by the script. The template generated by the script will be :

```ini
[MAIN]
CRF=0
PRESET=8
TUNE=1
CONV_COLORSPACE=0
CONV_PRORES=0
CONV_AVI=0
```
-   **CRF** 
    -   Constant Rate Factor is an integer value that allows the user to control the level of outputted quality. 
    -   This value ranges from `0-51` where `0` is **lossless** and `51` is the lowest quality
    -   By default this is set to `0` to ensure the highest quality for the outputted file, however may result in long encoding times depending on the input files number of frames, bitrate etc.
-   **PRESET**
    -   This is a collection of options directly built into ffmpeg that controls the ratio between encoding speed and compression.
    -   The config uses a set of integers ranging from `0-8` to map itself with the available options within ffmpeg. 
    -   The mapping is as follows:
    -   `veryslow=0`,`slower=1`,`slow=2`,`medium=3`,`fast=4`,`faster=5`,`veryfast=6`,`superfast=7`,`ultrafast=8`
    -   By default, the config is set for a high quality output, hence the `veryslow` preset being used.
-   **TUNE**
    -   This is a set of options within ffmpeg that use certain filters such as deblocking dependent on the type of input
    -   The config uses a set of integers ranging from `0-5` to map itself with the availble options within ffmpeg.
    -   The mapping is as follows:
    -   `film=0`,`animation=1`,`grain=2`,`stillimage=3`,`fastdecode=4`,`zerolatency=5`
    -   By default, the config is set for animation (`1`), since the script was made primarily for remuxing RAW anime.
    -   For more information on what each setting does, visit the first link after this list.
-   **CONV_COLORSPACE**
    -   This is a boolean value (`0 or 1`) that controls the output video's colorspace.
    -   By default ffmpeg converts all inputted videos into the [YUV Colorspace](https://en.wikipedia.org/wiki/YUV), however, if the inputted file was in the [RGB Colorspace](https://en.wikipedia.org/wiki/RGB_color_model), the colors of the outputted video may look vastly different.
    -   Using an option of `1` will enable the script to output a video within the RGB Colorspace.
        -   ***Note***: *If this setting is used, the outputted video file may be larger than the inputted video file.*
-   **CONV_PRORES**
    -   This is a boolean value (`0 or 1`) that controls the codec of the outputted video.
    -   While the goal of this script was to remux and not transcode videos in order to improve process times along with quality, the support has been added for the ProRes codec as it generally plays nicer with editing software, primarily the Adobe Suite.
    -   By default, the codec of the outputted video is copied from the inputted video, however changing this option to `1` will transcode the inputted video to use the ProRes codec.
        -   ***Note***: *If this setting is used, the outputted video file may be **much** larger than the inputted video file.*
-   **CONV_AVI**
    -   This is a boolean value (`0 or 1`) that will output the video in the `.avi` container.
        -   ***Note***: *The outputted file may be larger than the inputted file*
        -   ***Second Note***: *When used in conjuction with the `CONV_PRORES` setting, an exception will be caught and the process will terminate, for more infromation visit https://en.wikipedia.org/wiki/Comparison_of_video_container_formats*.
    -   Changing the value to `1` will change the outputted format to `.avi`.

For further understanding of these options, as well as the H.264 encoding, please visit this [website](https://trac.ffmpeg.org/wiki/Encode/H.264).

## Audio

Audio quality wasn't a **major** focus for the script, but there are a few features. In past versions, the script automatically capped the sampling frequency for auto at `22050`, however, currently the frequency is copied over from the inputted files.

However, in the case that the user wants to transcode to the ProRes codec, the audio quality will be in the `PCM_f32le` standard, in which it is in the floating 32-bit little endian format. The audio format had to be changed since ProRes does not support many audio formats typically seen in videos encoded with HEVC or MPEG.

## Troubleshooting

A few errors or weird quirks may arise when using this script. However, most problems are likely to be input mismatches. A few common problems are:

1.  Output video looks vastly different from inputted video.
    -   This is most likely due to the colorspace conversion. If the inputted file is in the [RGB Colorspace](https://en.wikipedia.org/wiki/RGB_color_model), and the `CONV_COLORSPACE` option is set to `0`, the outputted video will be in the [YUV Colorspace](https://en.wikipedia.org/wiki/YUV).
    -   The fix for this will be changing the `CONV_COLORSPACE` option in the config file to align with the colorspace. (Simply flip the value, to `0` or `1`)
2.  Cannot delete the `remuxed` folder nor the outputted video.
    -   This was an issue I had a few times while creating the script, from what I've gathered this is likely due to a bug with the Windows filesystem. A simple restart fixed this issue for me.
    -   A couple of characteristics indicating that you need a restart would be not being able to play the video through a player like [VLC](https://www.videolan.org/vlc/), as well as not being able to delete the ouptted file and/or the directory it resides in.
3.  Codec/Container conversion errors
    -   Another error that may occur when using the script is having issues trying to remux videos that use obsure codecs.
    -   Most of the video files you gather will likely be in HEVC or a similar format, however in the case that you are **A.** Missing a codec or **B.** Trying to copy a codec that the container doesn't support you can try these steps:
        -   **A.** First figure out the codec that you're missing and install it. If you have FFmpeg installed you can use the command right below this section to determine the codec, and then subsequently source it from online.
        -   **B.** The default container will be `.mp4` which supports a large number of popular and common codecs, however, in the case that there is such an error, I'd try first sourcing the video file from elsewhere. But, in the case that you cannot, try transcoding to ProRes setting the `CONV_PRORES` equal to `1` in the `conf.ini` file (ProRes files are typically 30 times larger than HEVC, so mind the available space).

If there are any other weird errors that occur, you can add an issue in the GitHub repository or message me on discord at `duran#8933`. 

## Credit

-   KiraEdits for originally introducing me to remuxing with ffmpeg back in 2021.
-   Gmzorz for his work on prorec as well as help with other projects.
-   Dre and Sofy for encouragement and showing me love.

## To-Do

-   [ ] Further testing into remuxing times
-   [x] How to use & install
-   [ ] Auto-config saving [NO LONGER NEEDED]
-   [ ] Simple and Advanced modes [NO LONGER NEEDED]
-   [x] Update the README.md


